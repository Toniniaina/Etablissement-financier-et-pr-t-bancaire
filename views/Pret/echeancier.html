<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Échéancier</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../../scss/style.scss" />
</head>
<body>

<!-- Header -->
<header class="header">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-bars"></i></button>
            <div class="logo ms-3">
                <i class="fas fa-university"></i><span>FinanceBank</span>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline-light btn-sm"><i class="fas fa-user"></i> Profil</button>
            <button class="btn btn-outline-light btn-sm"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
        </div>
    </div>
</header>

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h5>Menu Principal</h5>
        <div class="sidebar-subtitle">Gestion Financière</div>
    </div>
    <div class="nav-menu">
        <div class="nav-item"><a href="#" class="nav-link"><i class="fas fa-coins"></i><span>Gestion des Fonds</span></a></div>
        <div class="nav-item"><a href="#" class="nav-link"><i class="fas fa-calculator"></i><span>Simulation Prêt</span></a></div>
        <div class="nav-item"><a href="#" class="nav-link"><i class="fas fa-plus-circle"></i><span>Ajouter Prêt</span></a></div>
        <div class="nav-item"><a href="#" class="nav-link"><i class="fas fa-list"></i><span>Liste des Prêts</span></a></div>
        <div class="nav-item"><a href="#" class="nav-link active"><i class="fas fa-calendar-alt"></i><span>Échéancier</span></a></div>
        <div class="nav-item"><a href="#" class="nav-link"><i class="fas fa-chart-line"></i><span>Intérêts par Mois</span></a></div>
    </div>
    <div class="sidebar-footer">
        <div class="user-info">
            <div class="avatar"><i class="fas fa-user"></i></div>
            <div class="user-details">
                <div class="user-name">Admin</div>
                <div class="user-role">Gestionnaire</div>
            </div>
        </div>
    </div>
</nav>

<!-- Main -->
<main class="main-content" id="mainContent">
    <div class="content-wrapper">
        <div class="page-header">
            <h1><i class="fas fa-calendar-alt me-3"></i>Échéancier de remboursement</h1>
        </div>

        <!-- Recherche client -->
        <div class="row mb-4 fade-in">
            <div class="col-md-6">
                <label for="recherche" class="form-label">Nom ou prénom client :</label>
                <div class="input-group">
                    <input type="text" id="recherche" class="form-control" placeholder="Ex : Rakoto">
                    <button class="btn btn-primary" onclick="chercherClient()"><i class="fas fa-search me-1"></i> Rechercher</button>
                </div>
            </div>
        </div>

        <!-- Clients -->
        <div class="table-responsive fade-in">
            <h5 class="mt-4">Clients trouvés</h5>
            <table class="table table-bordered table-striped" id="table-clients">
                <thead class="table-light">
                <tr><th>ID</th><th>Nom</th><th>Prénom</th><th>Action</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Prêts -->
        <div class="table-responsive fade-in">
            <h5 class="mt-5">Prêts du client</h5>
            <table class="table table-bordered table-striped" id="table-prets">
                <thead class="table-light">
                <tr><th>ID</th><th>Montant</th><th>Date Début</th><th>Durée (mois)</th><th>Action</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Échéancier -->
        <div class="table-responsive fade-in">
            <h5 class="mt-5">Échéancier du prêt</h5>
            <table class="table table-bordered table-striped" id="table-echeancier">
                <thead class="table-light">
                <tr><th>Mois</th><th>Mensualité</th><th>Intérêt</th><th>Principal</th><th>Reste à payer</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</main>

<script>
    const base = "http://localhost/Etablissement-financier-et-pr-t-bancaire/ws";

    function ajax(method, url, data, callback) {
        const xhr = new XMLHttpRequest();
        xhr.open(method, base + url, true);
        xhr.onreadystatechange = () => {
            if (xhr.readyState === 4 && xhr.status === 200) {
                callback(JSON.parse(xhr.responseText));
            }
        };
        xhr.send(data);
    }

    function chercherClient() {
        const nom = document.getElementById("recherche").value.toLowerCase();
        ajax("GET", "/clients", null, (data) => {
            const tbody = document.querySelector("#table-clients tbody");
            tbody.innerHTML = "";
            const resultats = data.filter(c =>
                c.nom_clients.toLowerCase().includes(nom) || c.prenom_clients.toLowerCase().includes(nom)
            );
            resultats.forEach(client => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td>${client.id_clients}</td>
          <td>${client.nom_clients}</td>
          <td>${client.prenom_clients}</td>
          <td><button class="btn btn-sm btn-outline-primary" onclick="chargerPretsClient(${client.id_clients})"><i class="fas fa-eye"></i> Voir prêts</button></td>
        `;
                tbody.appendChild(tr);
            });
        });
    }

    function chargerPretsClient(idClient) {
        ajax("GET", "/prets", null, (data) => {
            const prets = data.filter(p => p.id_clients == idClient);
            const tbody = document.querySelector("#table-prets tbody");
            tbody.innerHTML = "";
            document.querySelector("#table-echeancier tbody").innerHTML = "";

            prets.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td>${p.id_prets}</td>
          <td>${parseFloat(p.montant_prets).toLocaleString('fr-FR')} Ar</td>
          <td>${p.date_debut}</td>
          <td>${p.duree_en_mois}</td>
          <td>
            <button class="btn btn-sm btn-success me-1" onclick="chargerEcheancier(${p.id_prets})">
              <i class="fas fa-calendar-alt"></i> Échéancier
            </button>
            <a href="${base}/export/export-pdf.php?id=${p.id_prets}" target="_blank" class="btn btn-sm btn-outline-danger">
              <i class="fas fa-file-pdf"></i> PDF
            </a>
          </td>
        `;
                tbody.appendChild(tr);
            });
        });
    }

    function chargerEcheancier(idPret) {
        ajax("GET", `/prets/echeancier?id=${idPret}`, null, (data) => {
            const tbody = document.querySelector("#table-echeancier tbody");
            tbody.innerHTML = "";
            data.forEach(e => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td>${e.mois}</td>
          <td>${e.mensualite.toLocaleString('fr-FR')} Ar</td>
          <td>${e.interet.toLocaleString('fr-FR')} Ar</td>
          <td>${e.principal.toLocaleString('fr-FR')} Ar</td>
          <td>${e.reste.toLocaleString('fr-FR')} Ar</td>
        `;
                tbody.appendChild(tr);
            });
        });
    }

    document.getElementById("sidebarToggle").addEventListener("click", () => {
        document.getElementById("sidebar").classList.toggle("collapsed");
        document.getElementById("mainContent").classList.toggle("sidebar-collapsed");
    });
</script>

</body>
</html>
