<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Liste des prêts</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      input,
      select,
      button {
        margin: 5px;
        padding: 5px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <h1>Liste des prêts</h1>
    <div>
      <input type="text" id="nom" placeholder="Nom client" />
      <input type="text" id="prenom" placeholder="Prénom client" />
      <select id="typePret">
        <option value="">-- Type de prêt --</option>
      </select>
      <button onclick="rechercherPrets()">🔍 Rechercher</button>
    </div>
    <table id="table-prets">
      <thead>
        <tr>
          <th>Client</th>
          <th>Type de prêt</th>
          <th>Montant</th>
          <th>Assurance</th>
          <th>Délai de grâce</th>
          <th>Date début</th>
          <th>Durée (mois)</th>
          <th>Statut</th>
          <th>Approuver</th>
          <th>Rejeter</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      const apiBase =
        "http://localhost/Etablissement-financier-et-pr-t-bancaire/ws";

      function ajax(method, url, data, callback) {
        const xhr = new XMLHttpRequest();
        xhr.open(method, apiBase + url, true);
        xhr.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded"
        );
        xhr.onreadystatechange = () => {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              callback(JSON.parse(xhr.responseText));
            } else {
              alert("Erreur : " + xhr.responseText);
            }
          }
        };
        xhr.send(data);
      }

      function chargerTypesPret() {
        ajax("GET", "/typesprets", null, (data) => {
          const select = document.getElementById("typePret");
          data.forEach((tp) => {
            const option = document.createElement("option");
            option.value = tp.id_types_pret;
            option.textContent = tp.nom_type_pret;
            select.appendChild(option);
          });
        });
      }

      function rechercherPrets() {
        const nom = document.getElementById("nom").value;
        const prenom = document.getElementById("prenom").value;
        const typePret = document.getElementById("typePret").value;

        const params = `nom=${encodeURIComponent(
          nom
        )}&prenom=${encodeURIComponent(prenom)}&id_types_pret=${typePret}`;
        ajax("POST", "/prets/search", params, afficherPrets);
      }

      function afficherPrets(data) {
        const tbody = document.querySelector("#table-prets tbody");
        tbody.innerHTML = "";

        data.forEach((p) => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
      <td>${p.nom_clients} ${p.prenom_clients}</td>
      <td>${p.nom_type_pret}</td>
      <td>${p.montant_prets} Ar</td>
      <td>${p.assurance ?? "-"}</td>
      <td>${p.delai_grace ?? 0}</td>
      <td>${p.date_debut}</td>
      <td>${p.duree_en_mois}</td>
      <td>${p.statut_actuel}</td>
      <td>
        ${
          p.statut_actuel.toLowerCase() === "en attente"
            ? `
              <button onclick="toggleForm(${p.id_prets}, 'approuver')">Approuver</button>
              <div id="form-approuver-${p.id_prets}" style="display:none; margin-top:5px;">
                <input type="date" id="dateApprobation-${p.id_prets}" />
                <button onclick="approuverPret(${p.id_prets})">Valider</button>
              </div>
            `
            : "-"
        }
      </td>
      <td>
        ${
          p.statut_actuel.toLowerCase() === "en attente"
            ? `
              <button onclick="toggleForm(${p.id_prets}, 'rejeter')">Rejeter</button>
              <div id="form-rejeter-${p.id_prets}" style="display:none; margin-top:5px;">
                <input type="date" id="dateApprobationRejet-${p.id_prets}" />
                <button onclick="rejeterPret(${p.id_prets})">Valider</button>
              </div>
            `
            : "-"
        }
      </td>
    `;

          tbody.appendChild(tr);
        });
      }

      function toggleForm(idPret, action) {
        const approuverForm = document.getElementById(
          `form-approuver-${idPret}`
        );
        const rejeterForm = document.getElementById(`form-rejeter-${idPret}`);

        if (action === "approuver") {
          // Ferme l'autre si ouvert
          if (rejeterForm) rejeterForm.style.display = "none";
          // Toggle celui-ci
          approuverForm.style.display =
            approuverForm.style.display === "none" ? "block" : "none";
        } else if (action === "rejeter") {
          if (approuverForm) approuverForm.style.display = "none";
          rejeterForm.style.display =
            rejeterForm.style.display === "none" ? "block" : "none";
        }
      }

      function approuverPret(idPret) {
        const dateInput = document.getElementById(`dateApprobation-${idPret}`);
        const dateMouvement = dateInput.value;

        if (!dateMouvement) {
          alert("Veuillez choisir une date d'approbation.");
          return;
        }

        const data = `id_prets=${idPret}&date_mouvement=${dateMouvement}`;
        ajax("POST", "/prets/approuver", data, (res) => {
          alert("Prêt approuvé avec succès !");
          rechercherPrets();
        });
      }

      function rejeterPret(idPret) {
        const dateInput = document.getElementById(
          `dateApprobationRejet-${idPret}`
        );
        const dateMouvement = dateInput.value;

        if (!dateMouvement) {
          alert("Veuillez choisir une date de rejet.");
          return;
        }

        const data = `id_prets=${idPret}&date_mouvement=${dateMouvement}`;
        ajax("POST", "/prets/rejeter", data, (res) => {
          alert("Prêt rejeté avec succès !");
          rechercherPrets();
        });
      }

      chargerTypesPret();
      rechercherPrets(); // pour afficher tout au début
    </script>
  </body>
</html>
